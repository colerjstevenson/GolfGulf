<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Golf Courses vs Demographics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #0b1222;
      --ink: #e6edf7;
      --muted: #93a4c4;
      --accent: #ff6b6b;
      --accent-2: #3dd6d0;
      --grid: #1e293b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Space Grotesk', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(61, 214, 208, 0.08), transparent 32%),
                  radial-gradient(circle at 80% 0%, rgba(255, 107, 107, 0.08), transparent 30%),
                  var(--bg);
      color: var(--ink);
      min-height: 100vh;
    }
    .shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 18px 48px;
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 18px;
    }
    h1 {
      font-size: 28px;
      letter-spacing: -0.01em;
      margin: 0;
    }
    p.lede {
      margin: 0;
      color: var(--muted);
      max-width: 820px;
      line-height: 1.5;
    }
    .panel {
      background: var(--panel);
      border: 1px solid #16213a;
      border-radius: 14px;
      padding: 16px 16px 12px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.25);
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
    }
    label {
      font-size: 14px;
      color: var(--muted);
    }
    select {
      background: #11182b;
      color: var(--ink);
      border: 1px solid #1f2a44;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      min-width: 220px;
      outline: none;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(61, 214, 208, 0.15);
      color: var(--ink);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
    }
    #chart {
      width: 100%;
      height: 520px;
    }
    .footnote {
      color: var(--muted);
      font-size: 13px;
      margin-top: 10px;
      line-height: 1.5;
    }
    .error {
      color: #ff9a9a;
    }
  </style>
</head>
<body>
  <main class="shell">
    <header>
      <h1>Golf Courses vs Demographics</h1>
      <p class="lede">Points show cities from the amenity collector—U.S. cities in red, Canadian cities in teal. The y-axis is golf course count; the x-axis switches between demographic indicators from official census data.</p>
    </header>

    <section class="panel">
      <div class="controls">
        <label for="metric">X-axis metric</label>
        <select id="metric"></select>
        <span class="pill" id="plotted-count">Loading…</span>
      </div>
      <div id="chart"></div>
      <div class="footnote" id="notes"></div>
    </section>
  </main>

  <script>
    const US_CITIES = [
      { city: 'New York', state: 'NY', country: 'USA' },
      { city: 'Los Angeles', state: 'CA', country: 'USA' },
      { city: 'Chicago', state: 'IL', country: 'USA' },
      { city: 'Houston', state: 'TX', country: 'USA' },
      { city: 'Phoenix', state: 'AZ', country: 'USA' },
      { city: 'Philadelphia', state: 'PA', country: 'USA' },
      { city: 'San Antonio', state: 'TX', country: 'USA' },
      { city: 'San Diego', state: 'CA', country: 'USA' },
      { city: 'Palm Springs', state: 'CA', country: 'USA' },
      { city: 'Scottsdale', state: 'AZ', country: 'USA' },
      { city: 'Dallas', state: 'TX', country: 'USA' },
      { city: 'San Jose', state: 'CA', country: 'USA' },
      { city: 'Austin', state: 'TX', country: 'USA' },
      { city: 'Jacksonville', state: 'FL', country: 'USA' },
      { city: 'Fort Worth', state: 'TX', country: 'USA' },
      { city: 'Columbus', state: 'OH', country: 'USA' },
      { city: 'Indianapolis', state: 'IN', country: 'USA' },
      { city: 'Charlotte', state: 'NC', country: 'USA' },
      { city: 'San Francisco', state: 'CA', country: 'USA' },
      { city: 'Seattle', state: 'WA', country: 'USA' },
      { city: 'Denver', state: 'CO', country: 'USA' },
      { city: 'Washington', state: 'DC', country: 'USA' },
      { city: 'Boston', state: 'MA', country: 'USA' },
      { city: 'Nashville', state: 'TN', country: 'USA' },
      { city: 'Detroit', state: 'MI', country: 'USA' },
      { city: 'Portland', state: 'OR', country: 'USA' },
      { city: 'Las Vegas', state: 'NV', country: 'USA' },
      { city: 'Toronto', state: 'ON', country: 'Canada' },
      { city: 'Vancouver', state: 'BC', country: 'Canada' },
      { city: 'Calgary', state: 'AB', country: 'Canada' },
      { city: 'Edmonton', state: 'AB', country: 'Canada' },
      { city: 'Winnipeg', state: 'MB', country: 'Canada' }
    ];

    const METRICS = [
      { key: 'population_total', label: 'Population total' },
      { key: 'median_age', label: 'Median age (years)' },
      { key: 'median_household_income', label: 'Median household income ($)' },
      { key: 'per_capita_income', label: 'Per capita income ($)' },
      { key: 'median_home_value', label: 'Median home value ($)' },
      { key: 'median_gross_rent', label: 'Median gross rent ($)' },
      { key: 'poverty_rate', label: 'Poverty rate (%)', transform: v => v * 100 },
      { key: 'unemployment_rate', label: 'Unemployment rate (%)', transform: v => v * 100 },
      { key: 'owner_share', label: 'Owner share (%)', transform: v => v * 100 },
      { key: 'renter_share', label: 'Renter share (%)', transform: v => v * 100 },
      { key: 'foreign_born_share', label: 'Foreign-born (%)', transform: v => v * 100 },
      { key: 'total_visible_minority_share', label: 'Visible minority (%)', transform: v => v * 100 },
      { key: 'white_alone_share', label: 'White alone (%)', transform: v => v * 100 },
      { key: 'black_or_african_american_alone_share', label: 'Black/African American (%)', transform: v => v * 100 },
      { key: 'south_asian_share', label: 'South Asian (%)', transform: v => v * 100 },
      { key: 'chinese_share', label: 'Chinese (%)', transform: v => v * 100 },
      { key: 'employed_total', label: 'Employed (count)' },
      { key: 'high_school', label: 'High school education (count)' },
    ];

    const slugify = (city, state) => city.trim().toLowerCase().replace(/\s+/g, '_') + '_' + state.trim().toLowerCase();

    const metricSelect = document.getElementById('metric');
    const plottedCount = document.getElementById('plotted-count');
    const notesEl = document.getElementById('notes');

    const applyNumber = (value, transform) => {
      if (value === null || value === undefined || Number.isNaN(value)) return null;
      const val = Number(value);
      return transform ? transform(val) : val;
    };

    function populateMetricSelect() {
      METRICS.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.key;
        opt.textContent = m.label;
        metricSelect.appendChild(opt);
      });
      metricSelect.value = METRICS[0].key;
    }

    function renderChart(data, metricKey) {
      const metric = METRICS.find(m => m.key === metricKey);
      if (!metric) return;

      const points = data
        .map(entry => {
          const rawX = entry.metrics ? entry.metrics[metric.key] : null;
          const x = applyNumber(rawX, metric.transform);
          const y = entry.golfCount;
          return { ...entry, x, y, rawX };
        })
        .filter(p => p.x !== null && p.y !== null);

      const trace = {
        x: points.map(p => p.x),
        y: points.map(p => p.y),
        text: points.map(p => `${p.city}, ${p.state} (${p.country})`),
        mode: 'markers',
        type: 'scatter',
        marker: {
          size: 12,
          color: points.map(p => p.country === 'Canada' ? '#3dd6d0' : '#ff6b6b'),
          line: { width: 1, color: '#ffffff' },
          opacity: 0.9,
        },
        hovertemplate: '%{text}<br>' +
          `${metric.label}: %{x}<br>` +
          'Golf courses: %{y}<extra></extra>',
      };

      const layout = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#e6edf7', family: 'Space Grotesk, Segoe UI, sans-serif' },
        xaxis: {
          title: metric.label,
          gridcolor: '#1e293b',
          zerolinecolor: '#1e293b',
        },
        yaxis: {
          title: 'Golf courses (count)',
          gridcolor: '#1e293b',
          zerolinecolor: '#1e293b',
        },
        margin: { l: 60, r: 30, t: 10, b: 60 },
      };

      Plotly.react('chart', [trace], layout, { displaylogo: false, responsive: true });
      plottedCount.textContent = `${points.length} cities plotted`;

      const missing = data.filter(d => !d.metrics || d.metrics[metric.key] === undefined || d.golfCount === null);
      notesEl.innerHTML = missing.length
        ? `${missing.length} cities missing data for "${metric.label}" or golf courses were skipped.`
        : 'All cities have data for the selected metric.';
    }

    async function init() {
      populateMetricSelect();
      try {
        const [amenities, demographics] = await Promise.all([
          fetch('data/city_amenities.json').then(r => r.json()),
          fetch('data/city_demographics.json').then(r => r.json()),
        ]);

        const merged = US_CITIES.map(entry => {
          const slug = slugify(entry.city, entry.state);
          const metrics = demographics[slug];
          const amenity = amenities[entry.city];
          const golfCount = amenity && amenity['golf courses'] ? amenity['golf courses'].count : null;
          return { ...entry, slug, metrics, golfCount };
        });

        metricSelect.addEventListener('change', (e) => renderChart(merged, e.target.value));
        renderChart(merged, metricSelect.value);
      } catch (err) {
        document.getElementById('chart').textContent = 'Failed to load data. Make sure the page can read data/city_amenities.json and data/city_demographics.json.';
        document.getElementById('chart').classList.add('error');
        console.error(err);
      }
    }

    init();
  </script>
</body>
</html>
